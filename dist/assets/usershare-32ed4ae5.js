import{d as P}from"./pinia-2f8cef2e.js";import{a as u}from"./axios-fa38e072.js";import{m}from"./@multiavatar-b28f2a65.js";import{C as k}from"./crypto-js-74ece96e.js";import{m as A}from"./ant-design-vue-a7ef973d.js";const I="ekmdIrnqOs0YivHfQXRCPGTcX8Y1uan4";function x(e){return k.MD5(e).toString()}function C(e=32){let t="";for(;t.length<e;)t+=Math.random().toString(36).substring(2);return t.substring(0,e)}function L(e){const t=Date.now(),s=C(),a=`nonce=${s}&timestamp=${t}&usertoken=${e}&key=${I}`,i=x(a);return`?usertoken=${e}&nonce=${s}&timestamp=${t}&sign=${i}`}const c=m("3388ai"),v=P("userStore",{state:()=>({userToken:null,userAvatar:c,createTime:null,updateTime:null,expireTime:null,isPlus:!1,userCount:null,userArray:[],isLogin:JSON.parse(localStorage.getItem("isLogin")||"false"),expired:!1,daysBetween:0,loginModal:!1,CdkeyModal:!1,fetching:!1,fetchPromise:null}),actions:{async fetchUserData(e){const t=L(e);return this.fetching?this.fetchPromise:(this.fetching=!0,this.fetchPromise=new Promise(async(s,a)=>{try{const i=window.VITE_API_BASE_URL,n=await u.post(`${i}/app/user/userlogin`+t,{usertoken:e},{withCredentials:!0});console.log(n.headers);const{userToken:r,expireTime:o,isPlus:h,count:g,userarray:f,updateTime:p,createTime:d,accesstoken:T}=n.data.data;if(r){const S=new Date,w=new Date(o).getTime()-S.getTime(),l=Math.floor(w/(1e3*60*60*24)),y=l<=0;this.userToken=r,this.createTime=d,this.updateTime=p,this.expireTime=o,this.isPlus=h,this.userCount=g,this.userArray=f,this.isLogin=!0,this.userAvatar=m(r),this.daysBetween=l,this.expired=y,localStorage.setItem("accesstoken",T),localStorage.setItem("isLogin","true"),s(!0)}else localStorage.setItem("isLogin","false"),s(!1)}catch{localStorage.setItem("isLogin","false"),s(!1),A.warning("用户接口请求错误，请检查接口地址是否正确！")}finally{this.fetching=!1,this.fetchPromise=null}}),this.fetchPromise)},logout(){const e=window.VITE_API_BASE_URL;u.post(`${e}/app/user/logout`,{},{withCredentials:!0}),this.userToken=null,this.userAvatar=c,this.createTime=null,this.updateTime=null,this.expireTime=null,this.isPlus=!1,this.userCount=0,this.userArray=[],this.isLogin=!1,this.expired=!1,this.daysBetween=0,localStorage.removeItem("isLogin")}}});export{v as u};
