import{d as L}from"./pinia-98ec2995.js";import{i as c}from"../index-a1ae2b62.js";import{b as p}from"./@multiavatar-7283d2b3.js";import{C as i}from"./crypto-js-3b32aad8.js";import{m as B}from"./ant-design-vue-32902922.js";const S="ekmdIrnqOs0YivHfQXRCPGTcX8Y1uan4";function C(e){return i.MD5(e).toString()}function E(e=32){let t="";for(;t.length<e;)t+=Math.random().toString(36).substring(2);return t.substring(0,e)}function M(e){const t=Date.now(),n=E(),s=`nonce=${n}&timestamp=${t}&useremail=${e}&key=${S}`,u=C(s);return`?useremail=${e}&nonce=${n}&timestamp=${t}&sign=${u}`}function h(e){const t=i.enc.Utf8.parse(S);return i.AES.decrypt(e,t,{mode:i.mode.ECB,padding:i.pad.Pkcs7}).toString(i.enc.Utf8)}const d=p("shareflowadmin"),j=L("userStore",{state:()=>({useremail:null,invcode:null,userToken:null,userID:0,userAvatar:d,createTime:null,updateTime:null,expireTime:null,isPlus:!1,userCount:null,userArray:[],isLogin:JSON.parse(localStorage.getItem("isLogin")||"false"),expired:!1,daysBetween:0,loginModal:!1,registModel:!1,passModel:!1,invcodeModel:!1,userTokenModel:!1,CdkeyModal:!1,fetching:!1,fetchPromise:null}),actions:{async fetchUserData(e,t,n){return this.fetching?this.fetchPromise:(this.fetching=!0,this.fetchPromise=new Promise(async(s,u)=>{try{const o=window.VITE_API_BASE_URL;let r;if(e&&t){const l=M(e);r=await c.post(`${o}/app/user/login${l}`,{useremail:e,password:t,share:n})}else r=await c.post(`${o}/app/user/info`);const{useremail:m,invcode:T,userToken:f,expireTime:g,isPlus:k,count:y,userarray:w,updateTime:I,createTime:v}=r.data.data;if(f){const l=new Date,P=new Date(g).getTime()-l.getTime();let a=Math.floor(P/(1e3*60*60*24));const x=a<=0;a=a<0?0:a,this.useremail=m,this.userToken=f,this.invcode=T,this.createTime=v,this.updateTime=I,this.expireTime=g,this.isPlus=k,this.userCount=y,this.userArray=w,this.isLogin=!0,this.userAvatar=p(m),this.daysBetween=a<=0?1:a+1,this.expired=x;let A=h(r.data.data.xauthorization.resfreshtoken),$=h(r.data.data.xauthorization.accesstoken);localStorage.setItem("accesstokenname",A),localStorage.setItem("accesstokenvalue",$),localStorage.setItem("isLogin","true"),s(!0)}else localStorage.setItem("isLogin","false"),s(!1)}catch{localStorage.setItem("isLogin","false"),s(!1),B.warning("用户接口请求错误，请检查接口地址是否正确！")}finally{this.fetching=!1,this.fetchPromise=null}}),this.fetchPromise)},logout(){const e=window.VITE_API_BASE_URL;c.post(`${e}/app/user/logout`),this.resetState()},resetState(){this.userToken=null,this.useremail=null,this.invcode=null,this.userAvatar=d,this.createTime=null,this.updateTime=null,this.expireTime=null,this.isPlus=!1,this.userCount=0,this.userArray=[],this.isLogin=!1,this.expired=!1,this.daysBetween=0,localStorage.removeItem("isLogin"),localStorage.removeItem("accesstokenname"),localStorage.removeItem("accesstokenvalue")}}});export{M as g,j as u};
