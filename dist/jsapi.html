<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信支付页面</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div>
    <h1>微信支付页面</h1>
    <button id="payButton">发起支付</button>
</div>

<script>
    $(document).ready(function() {
        var code = '';
        var orderno = '';
        var prepayId = '';
        var apiBaseUrl = '';


        function getQueryParams(url) {
            const params = {};
            const parser = new URL(url);
            const queryString = parser.search.substring(1);
            const queryArr = queryString.split('&');

            queryArr.forEach(param => {
                const [key, value] = param.split('=');
                params[key] = decodeURIComponent(value);
            });

            return params;
        }

        // 获取微信code
        function getWeChatCode() {
            const url = window.location.href;
            console.log(url);
            const queryParams = getQueryParams(url);
            code = queryParams['code'];
            orderno = queryParams['orderno'];
        }


        // 发起支付
        function initiatePayment() {
            if (!code) {
                alert('微信code未获取到');
                return;
            }

            $.ajax({
                type: 'POST',
                url: apiBaseUrl + '/app/call/jsapipay',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({
                    code: code,
                    orderno: orderno
                }),
                success: function(response) {
                    prepayId = response.data.prepay_id;

                    wx.config({
                        debug: true, // 在生产环境中请关闭debug模式
                        appId: response.data.appId,
                        timestamp: response.data.timestamp,
                        nonceStr: response.data.nonceStr,
                        signature: response.data.paySign,
                        jsApiList: ['chooseWXPay']
                    });

                    wx.ready(function() {
                        wx.checkJsApi({
                            jsApiList: ['chooseWXPay'],
                            success: function(res) {
                                console.log('API check success:', res);
                            },
                            fail: function(res) {
                                console.log('API check fail:', res);
                            }
                        });

                        wx.chooseWXPay({
                            nonceStr: response.data.nonceStr,
                            package: 'prepay_id=' + prepayId,
                            signType: 'RSA',
                            paySign: response.data.paySign,
                            timestamp: response.data.timestamp,
                            success: function(res) {
                                alert('支付成功');
                            },
                            fail: function(res) {
                                alert('支付失败: ' + res.errMsg);
                            }
                        });
                    });

                    wx.error(function(err) {
                        alert('微信配置错误: ' + err);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });
        }

        // 获取配置
        function getConfig() {
            $.ajax({
                url: '/list/config.json',
                method: 'GET',
                success: function(data) {
                    apiBaseUrl = data.VITE_API_BASE_URL;
                },
                error: function(error) {
                    console.error('Error fetching config:', error);
                }
            });
        }

        $('#payButton').on('click', initiatePayment);

        // 初始化
        getConfig();
        getWeChatCode();
    });
</script>
</body>
</html>




